---
title: "Chromosome compation - simple 3-state model"
author: "Marek Gierlinski"
output: html_document
---


```{r setup, include=FALSE}
library(ChromCom)
library(knitr)
library(mylib)
binDir <- "../RData"
opts_chunk$set(fig.path='../figure/mpd3-', 
               cache.path='../cache/mod3-', 
               fig.align='center',
               external=TRUE,
               echo=FALSE,
               warning=FALSE,
               message=FALSE,
               fig.pos='H',
               fig.width=4,
               fig.height=3
              )
```

## Data

```{r}
echr <- experimentalData(dataFile$scramble)
smth <- 5
```

In our data we distinguish four states, marked by colour: blue, brown, pink, red. For the purpose of the model we merge blue and brown together into one state. Here is the result of the experiment from `r nrow(echr$cells)` cells.

```{r}
plotCells(echr)
```

The next figure shows the proportions of each colour as a function of time. The curves are smoothed with a running mean over the window of `r smth` time points.

```{r}
plotTimelines(echr, smooth=TRUE, k=smth)
```


## Model

The model consists of three states and a set of rules.

### States

* blue/brown (B)
* pink (P)
* red (R)
 
### Rules

- Simulation is carried out at a discrete time step of 1 min
- The cell is in state B before time $t_1$.
- B$\rightarrow$P occurs after $t_1$ with rate $k_1$
- P$\rightarrow$R occurs after $t_1 + \Delta t_2$ with rate $k_2$
- P$\rightarrow$B occurs after $t_1 + \Delta t_3$ with rate $k_3$

### Details

There are two ways the model can be calculated. The transition model is simpler, but does not allow for P$\rightarrow$B transitions. The simulation model is more flexible and, at this moment, applied as default.

#### "Transition" model

For each cell we generate two transitions times (B$\rightarrow$P and P$\rightarrow$R) according to an exponential distribution, 

\[
\begin{eqnarray}
Pr(B \rightarrow P; t) & = & 1 - e^{-k_1 (t - t_1)} \\
Pr(P \rightarrow R; t) & = & 1 - e^{-k_2 \left[t - (t_1 + t_{\rm BP} + \Delta t_2\right]}
\end{eqnarray}
\]

where $t_{\rm BP}$ is the B$\rightarrow$P transition time, generated with the first distribution. The exponential distribution describes a process with constant probability of the event happening. From transition times we build the timeline of the cell, its state as a function of time. 

#### "Simulation" model

This is a Markov chain approach. The next state is generated from the current state based on rules outlined above. The rates, $k$, are converted into probabilites over a given time step $\Delta t$ as $Pr = 1 - e^{1 - k\Delta t}$.

With either approach the cell timeline is repeated for 3000 times and then the colour propotions are found at each time point.

### Example

Here is an example of the model.

```{r, fig.width=4, fig.height=3}
pars <- c3pars(
  t1 = -30,
  dt2 = 0,
  k1 = 0.05,
  k2 = 0.03
)
chr <- ChromCom3(pars)
chr <- generateCells(chr)
plotTimelines(chr, withpars=TRUE)
```

### Parameter tuner

There is a [shiny app](https://shiny.compbio.dundee.ac.uk/marek_chromcom/param_tuner/) that allows tuning parameters in search for the best solution.

## Fitting model to the data

I attempted fitting model to our data. It is not an easy task, as the model is stochastic. After some testing I found that modified BFGS (a quasi-Newton method, also known as a variable metric algorithm, by Broyden, Fletcher, Goldfarb and Shanno, 1970) which allowes box constraintes (Byrd et. al. 1995), gives reasonable results. Again, due to stochasticity of the model, this algorithm often finds false local minima. I run it several times to find the best minimum. It is a crude and time-consuming method, but gives results better than manual tuning.

Fitting is constrained to time points between -90 nd 30 min. The minimized quantity is

$\chi^2 = \sum_{c \in \{B,P,R\}} \sum_i \frac{(O_{c,i} - E_{c,i})^2}{E_{c,i}}$

### Scramble results

First, I allow for $t_1$, $k_1$ nad $k_2$ to be free. $\Delta t_2$, $\Delta t_3$ and $k_3$ are set to zero. Then, I repeat the fit with $\Delta t_2$ allowed to be free. The three-parameter model result is on the left, the four-parameter model is on the right.

```{r, fig.width=10}
pars <- c3pars()
chr3 <- cacheData("fit_scramble_n3000_3par", fitChr, echr, pars, npar=3, nsim=3000, ntry=16, binDir=binDir)
g1 <- plotTimelines(chr3, expdata = echr, withpars=TRUE)

pars <- c3pars(dt2=5)
chr4 <- cacheData("fit_scramble_n3000_4par", fitChr, echr, pars, npar=4, nsim=3000, ntry=16, binDir=binDir)
g2 <- plotTimelines(chr4, expdata = echr, withpars=TRUE)
grid.arrange(g1, g2, ncol=2)
```

```{r}
F <- chr3$chi2 / chr4$chi2
dof3 <- chr3$timepars$n - 3
dof4 <- chr4$timepars$n - 4
p <- 1 - pf(F, dof3, dof4)
```

Improvement in $\chi^2$ is small and statistically insignificant (p = `r round(p,2)`). Therefore, we chose the three-parameter model for this data set.
