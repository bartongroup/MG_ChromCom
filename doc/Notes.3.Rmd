---
title: "Chromosome compaction - simple three-state model"
output: 
  html_notebook:
    toc: false
    toc_float: false
    code_folding: hide
    css: nice_notebook.css
---

```{r}
library(mylib)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(parallel)
library(latex2exp)

source("../R/lib.R")
binDir <- "../RData"
```


```{r, warning=FALSE}
echr <- lapply(dataFile, experimentalData)
```

This is a continuation of the previous notebook, [Notes.2](), with a new model.


# 31/08/2017

Implementing changes as outlined in the discussion. Now we can force pink to peak before zero, by tweaking the $t_0$ parameter.

```{r, fig.width=5, fig.height=3}
pars <- c3pars(
  t0 = -10,
  tau1 = 10,
  tau2 = 10,
  k1 = 0.05,
  k2 = 0.04
)
chr <- ChromCom3(pars)
chr <- generateCells(chr, nsim=1000)
plotTimelines(chr)
```


## Scramble

I did try to fit with five parameters (including $t_0$), but `optim` crashed sooner or later with uncomprehensible error messages. We need to fix $t_0$.

```{r}
pars <- c3pars(
  t0 = -10,
  tau1 = 15.3,
  tau2 = 9,
  k1 = 0.047,
  k2 = 0.064
)
free <- c("tau1", "k1", "k2", "tau2")
chr.scr.10 <- cacheData("fitt_scramble_n10000_t.10_tau1_k1_k2_tau2", fitChr, echr$scr, pars, free, nsim=10000, ntry=100, ncores=6, binDir=binDir)

pars$t0 <- -5
chr.scr.5 <- cacheData("fitt_scramble_n10000_t.5_tau1_k1_k2_tau2", fitChr, echr$scr, pars, free, nsim=10000, ntry=100, ncores=6, binDir=binDir)

pars$t0 <- -15
chr.scr.15 <- cacheData("fitt_scramble_n10000_t.15_tau1_k1_k2_tau2", fitChr, echr$scr, pars, free, nsim=10000, ntry=100, ncores=6, binDir=binDir)

pars$t0 <- 0
chr.scr.0 <- cacheData("fitt_scramble_n10000_t.0_tau1_k1_k2_tau2", fitChr, echr$scr, pars, free, nsim=10000, ntry=100, ncores=6, binDir=binDir)
```


```{r, fig.width=5}
plotTimelines(chr.scr.0, expdata = echr$scr, withpars=TRUE)
plotTimelines(chr.scr.5, expdata = echr$scr, withpars=TRUE)
plotTimelines(chr.scr.10, expdata = echr$scr, withpars=TRUE)
plotTimelines(chr.scr.15, expdata = echr$scr, withpars=TRUE)
```
# 04/09/2017

Need to do this on the cluster. Made a little script `fitting.Rs` to fit one set. Lets try is.

```{r eval=FALSE}
script <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/R/fitting.Rs"
logDir <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/log/"

for(set in names(dataFile)) {
  name <- paste0("fitt_", set, "_t0_n100000_tau1_k1_k2_tau2")
  cmd <- paste("Rscript", script, set, name)
  qsub(cmd, logDir, name=name)
}
```

# 05/09/2017

Fit results are ready. Lets have a look

```{r eval=FALSE}
nm <- names(dataFile)
nm <- nm[which(nm != "MK1775_ICRF193")]
chr <- lapply(nm, function(set) {
  name <- paste0("fitt_", set, "_t0_n10000_tau1_k1_k2_tau2")
  cacheData(name, fitChr, binDir=binDir, cacheonly=TRUE)
})
names(chr) <- names(dataFile)
```


```{r eval=FALSE, fig.width=6, fig.height=4}
for(name in names(dataFile)) {
  print(plotTimelines(chr[[name]], expdata = echr[[name]], withpars=TRUE, title=name))
}
```


There are serious issues with data file MK1775andICRF193_noncoloured.csv. First, there are strings "ICRF" in it. Second, there seem to be 6 empty columns at the end. It needs redoing.


# 15/09/2017

The `MK1775andICRF193` file is now corrected. Fit it.

```{r eval=FALSE}
script <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/R/fitting.Rs"
logDir <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/log/"

set <- "MK1775_ICRF193"
name <- paste0("fitt_", set, "_t0_n100000_tau1_k1_k2_tau2")
cmd <- paste("Rscript", script, set, name)
qsub(cmd, logDir, name=name)
```

## Meeting with Tomo and John

- change slider rates - upper limit to 0.5
- change font size so rms is visible
- fit range from -50 to +30
- modify model: add a switch $t_2 = t_1 + R(\tau_2)$ or $t_2 = t_0 + R(\tau_2)$; this can help with red curves that seem to all go up at 0, for all conditions
- later: fit by changing only one param from data to data


The model is changed. See the switch difference.

```{r, fig.width=5, fig.height=3}
pars <- c3pars(
  t0 = 0,
  tau1 = 40,
  tau2 = 40,
  k1 = 0.05,
  k2 = 0.04,
  t2ref = 1
)
chr <- ChromCom3(pars)
chr <- generateCells(chr, nsim=1000)
plotTimelines(chr, withpars = TRUE)
```

```{r, fig.width=5, fig.height=3}
pars <- c3pars(
  t0 = 0,
  tau1 = 40,
  tau2 = 10,
  k1 = 0.02,
  k2 = 0.04,
  t2ref = 0
)
chr <- ChromCom3(pars)
chr <- generateCells(chr, nsim=1000)
plotTimelines(chr, withpars=TRUE)
```

A quick scramble fit with the new switch.

```{r}
pars <- c3pars(
  t0 = -10,
  tau1 = 120,
  tau2 = 4,
  k1 = 0.02,
  k2 = 0.064,
  t2ref = 0
)
free <- c("tau1", "k1", "k2", "tau2")
chrs.scr <- fitChr(echr$scr, pars, free, nsim=100, ntry=10, ncores=6)
```

```{r, fig.width=5}
plotTimelines(chrs.scr, expdata = echr$scr, withpars=TRUE)
```





Submitting jobs to the cluster and naively expecting for them not to crash over the weekend. Since the t2ref=0 model look dodgy, I only run t2ref=1.

```{r eval=FALSE}
script <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/R/fitting.Rs"
logDir <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/log/"
switch <- 1

for(set in names(dataFile)) {
  name <- paste0("fits_", set, "_ref1_t0_n100000_tau1_k1_k2_tau2")
  cmd <- paste("Rscript", script, set, name, switch)
  qsub(cmd, logDir, name=name)
}
```

# 18/09/2017

There were some problems with fit limtis. I think I should fit it again.

Struggling with TeX expression and multi-line title. Reverting to simple text.

# 19/09/2017

Doing interviews today, so very little time. Trying running the new switch model.

```{r eval=FALSE}
script <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/R/fitting.Rs"
logDir <- "/cluster/gjb_lab/mgierlinski/projects/chromcomR/log/"
switch <- 0

for(set in names(dataFile)) {
  name <- paste0("fits_", set, "_ref0_t0_n1000_tau1_k1_k2_tau2")
  cmd <- paste("Rscript", script, set, name, switch, 1000, 30)
  qsub(cmd, logDir, name=name)
}
```

Looking at data I have an impression that red curves start a bit earlier than 0. Try the same model but $t_0 = -10$.

```{r eval=FALSE}
switch <- 0

for(set in names(dataFile)) {
  name <- paste0("fits_", set, "_ref0_t10_n1000_tau1_k1_k2_tau2")
  cmd <- paste("Rscript", script, set, name, switch, 1000, 30, -10)
  qsub(cmd, logDir, name=name)
}
```
